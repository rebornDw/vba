Sub Compare_AFT_With_BEF_CellLevel()

    Dim wsAft As Worksheet, wsBef As Worksheet, wsMaster As Worksheet
    Set wsAft = Sheets("aft")
    Set wsBef = Sheets("bef")
    Set wsMaster = Sheets("master")

    Dim lastCol As Long
    lastCol = wsAft.Cells(2, Columns.Count).End(xlToLeft).Column

    ' ===== Key 列 =====
    Dim keyCols As Object
    Set keyCols = CreateObject("Scripting.Dictionary")

    Dim c As Long
    For c = 1 To lastCol
        If wsAft.Cells(3, c).Value <> "" Then keyCols(c) = True
    Next c

    If keyCols.Count = 0 Then
        MsgBox "未定义唯一 Key（第3行）", vbCritical
        Exit Sub
    End If

    ' ===== master 中可比较字段 =====
    Dim compareCols As Object
    Set compareCols = CreateObject("Scripting.Dictionary")

    For c = 1 To lastCol
        If wsMaster.Cells(4, c).Value = "○" Then
            compareCols(c) = wsMaster.Cells(2, c).Value
        End If
    Next c

    ' ===== aft 结果列 =====
    Dim resultCol As Long, diffCol As Long
    resultCol = lastCol + 1
    diffCol = lastCol + 2

    wsAft.Cells(1, resultCol).Value = "比较结果"
    wsAft.Cells(1, diffCol).Value = "不一致字段"

    ' ===== bef Key Map =====
    Dim befMap As Object
    Set befMap = CreateObject("Scripting.Dictionary")

    Dim r As Long
    For r = 5 To wsBef.Cells(Rows.Count, 1).End(xlUp).Row
        befMap(GetKeyValue(wsBef, r, keyCols)) = r
    Next r

    ' ===== 主比较 =====
    Dim aftRow As Long
    For aftRow = 5 To wsAft.Cells(Rows.Count, 1).End(xlUp).Row

        ' 清除旧颜色
        wsAft.Rows(aftRow).Interior.ColorIndex = xlNone

        Dim keyVal As String
        keyVal = GetKeyValue(wsAft, aftRow, keyCols)

        If Not befMap.exists(keyVal) Then
            wsAft.Cells(aftRow, resultCol).Value = "NG"
            wsAft.Cells(aftRow, diffCol).Value = "KEY_NOT_FOUND"
            GoTo NextRow
        End If

        Dim befRow As Long
        befRow = befMap(keyVal)

        Dim ngList As String
        ngList = ""

        Dim colIndex As Variant
        For Each colIndex In compareCols.Keys

            ' 先清颜色
            wsAft.Cells(aftRow, colIndex).Interior.ColorIndex = xlNone

            If wsAft.Cells(aftRow, colIndex).Text <> wsBef.Cells(befRow, colIndex).Text Then
                ngList = ngList & compareCols(colIndex) & ", "
                wsAft.Cells(aftRow, colIndex).Interior.Color = RGB(255, 180, 180)
            End If

        Next colIndex

        If ngList = "" Then
            wsAft.Cells(aftRow, resultCol).Value = "OK"
            wsAft.Cells(aftRow, diffCol).Value = ""
        Else
            wsAft.Cells(aftRow, resultCol).Value = "NG"
            wsAft.Cells(aftRow, diffCol).Value = Left(ngList, Len(ngList) - 2)
        End If

NextRow:
    Next aftRow

    MsgBox "比较完成（已标红 NG 单元格）", vbInformation

End Sub


Function GetKeyValue(ws As Worksheet, r As Long, keyCols As Object) As String
    Dim c As Variant, keyVal As String
    For Each c In keyCols.Keys
        keyVal = keyVal & "|" & ws.Cells(r, c).Text
    Next c
    GetKeyValue = keyVal
End Function
